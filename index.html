<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA SUPPORT -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>WACKO CLASSIC TOUCH – Beaver Edition</title>
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
            touch-action: manipulation;
        }

        body {
            /* Desktop Backdrop */
            background: #202020;
            /* Dark background for desktop */
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            /* Fallback */
            height: 100dvh;
            /* Dynamic Viewport Height */
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centers the app frame */
        }

        /* ========== APP FRAME (The "Phone") ========== */
        #app-frame {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 450px;
            /* Mobile width simulation */
            max-height: 850px;
            /* Mobile height simulation */
            /* Game Background moves here */
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('background.png') no-repeat center center;
            background-size: cover;
            overflow: hidden;
            /* Clip content */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            /* Desktop shadow */
        }

        /* Ambient Particles (Inside Frame) */
        #app-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }

        @media (min-width: 500px) {

            /* Desktop Polish */
            #app-frame {
                border-radius: 20px;
                border: 8px solid #333;
            }
        }

        /* ========== HEADER LAYOUT ========== */
        #header-container {
            width: 90%;
            /* Relative to frame */
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            padding: 10px 0;
            margin-bottom: 20px;
            gap: 10px;
            z-index: 20;
            flex-shrink: 0;
            min-height: 60px;
        }

        /* RESUSABLE WOOD STYLES (PREMIUM GLOSS) */
        :root {
            --wood-light: #d49e62;
            --wood-dark: #8b5a2b;
            --wood-border: #5e3b1f;
            --text-gold: #fff5e6;
            --text-shadow: #3e2723;
        }

        /* WOOD BUTTONS (Icon Style) */
        .wood-btn {
            background: linear-gradient(180deg, #e3b67c 0%, #8b5a2b 100%);
            border: 3px solid var(--wood-border);
            border-radius: 16px;
            flex: 0 0 auto;
            /* Don't grow or shrink arbitrarily */
            width: 15%;
            /* Relative width */
            min-width: 55px;
            /* Minimum touch size */
            max-width: 70px;
            height: auto;
            aspect-ratio: 1;
            /* Keep square-ish */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-weight: 900;
            font-size: clamp(20px, 5vw, 24px);
            /* Fluid font size */
            text-shadow: 0 2px 0 var(--text-shadow);
            box-shadow:
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
        }

        .wood-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            filter: brightness(0.9);
        }

        /* WOOD PANEL (Center Board) */
        .wood-panel {
            flex-grow: 1;
            background: linear-gradient(180deg, #d49e62 0%, #8b5a2b 100%);
            border: 3px solid var(--wood-border);
            border-radius: 16px;
            padding: 5px 15px;
            display: flex;
            justify-content: space-around;
            /* Distribute items evenly */
            align-items: center;
            box-shadow:
                inset 0 3px 0 rgba(255, 255, 255, 0.3),
                0 6px 12px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .stat-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .wood-label {
            font-size: clamp(10px, 3vw, 12px);
            /* Fluid */
            color: #f0e6d2;
            font-weight: 800;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .wood-value {
            font-size: clamp(18px, 6vw, 24px);
            /* Fluid */
            color: #fff;
            font-weight: 900;
            text-shadow: 0 2px 0 var(--text-shadow);
            line-height: 1;
        }

        /* ========== GAME GRID FRAME ========== */
        #game-container {
            width: 90%;
            /* Relative to frame */
            aspect-ratio: 1;
            max-width: 400px;
            background: transparent;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            position: relative;
            z-index: 5;
            outline: none;
        }


        /* Shake Animation Source */
        .shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        /* ========== HOLE (CELL) ========== */
        .cell {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('hole.png');
            background-size: contain;
            /* Ensure hole fits in cell */
            background-repeat: no-repeat;
            background-position: center bottom;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.05s;
            /* Flex to center content if needed */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* Align to bottom where hole is */
        }

        .cell:active {
            transform: scale(0.95);
        }

        /* ========== PAUSE SCREEN ========== */
        #pause-screen {
            position: absolute;
            /* Changed from fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #pause-screen.show {
            display: flex;
        }

        .pause-menu {
            background: linear-gradient(180deg, #8b5a2b 0%, #6d421b 100%);
            border: 4px solid #4a2c11;
            border-radius: 20px;
            padding: 30px;
            width: 80%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .pause-title {
            font-size: 32px;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 2px 0 #5c3615;
            margin-bottom: 20px;
        }

        .menu-btn {
            background: #4a90e2;
            border: none;
            border-bottom: 4px solid #2a5f9e;
            color: white;
            font-weight: bold;
            font-size: 18px;
            padding: 12px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .menu-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .menu-btn.resume {
            background: #39ff14;
            border-color: #228b0f;
            color: #052902;
        }

        .menu-btn.quit {
            background: #ff4757;
            border-color: #b31d2a;
        }

        /* ========== GAME OVER SCREEN ========== */
        #game-over {
            position: absolute;
            /* Changed from fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #game-over.show {
            display: flex;
            animation: fadeIn 0.5s;
        }

        .game-over-img {
            width: 60vmin;
            height: 60vmin;
            max-width: 400px;
            max-height: 400px;
            margin-bottom: 2vh;
            background-image: url('over.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .game-over-text {
            font-size: clamp(32px, 8vmin, 48px);
            font-weight: bold;
            color: #ff4757;
            margin-bottom: 2vh;
            text-transform: uppercase;
        }

        .game-over-stats {
            display: flex;
            gap: 4vh;
            margin-bottom: 3vh;
            font-size: clamp(16px, 4vmin, 24px);
            color: #aaa;
        }

        .game-over-stats div {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-over-stats span {
            font-size: clamp(24px, 6vmin, 36px);
            font-weight: bold;
            margin-top: 5px;
        }

        .restart-btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 1rem 3rem;
            border-radius: 30px;
            font-size: clamp(16px, 4vmin, 18px);
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        /* Intro Stats */
        .intro-stats {
            position: relative;
            z-index: 20;
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 30px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .intro-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .intro-stat-item .label {
            font-size: 12px;
            color: #aaa;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .intro-stat-item .value {
            font-size: clamp(24px, 6vw, 28px);
            color: #fff;
            font-weight: bold;
        }

        /* Helpers */
        .shake {
            animation: shake 0.4s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ========== BEAVER & IMAGES ========== */
        .beaver {
            width: 100%;
            height: 100%;
            position: absolute;
            bottom: -85%;
            left: 0;
            animation: popUp 0.3s ease-out forwards;
        }

        .beaver.miss {
            animation: popDown 0.3s ease-in forwards;
        }

        @keyframes popUp {
            from {
                bottom: -8%;
            }

            to {
                bottom: -1%;
            }
        }

        @keyframes popDown {
            from {
                bottom: -1%;
            }

            to {
                bottom: -85%;
            }
        }

        .beaver-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* The Image Element */
        .beaver-img {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center bottom;
            background-repeat: no-repeat;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: transform 0.1s;
        }

        /* STATES (Images) */
        .beaver-img.normal {
            background-image: url('normal.png');
        }

        .beaver-img.yes {
            background-image: url('yes.png');
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .beaver-img.no {
            background-image: url('no.png');
            filter: grayscale(0.5);
        }

        /* MASKING FOR HOLE DEPTH */
        .hole-mask {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        /* COMBO ANIMATION */
        .combo-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }

        .combo-pop {
            font-size: 80px;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            animation: comboAnim 0.5s ease-out forwards;
        }

        @keyframes comboAnim {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Intro Screen */
        #intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #intro-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .intro-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
            z-index: 1;
        }

        .game-title {
            font-size: 60px;
            font-weight: 900;
            color: #ffd700;
            text-align: center;
            text-shadow: 0 5px 0 #b8860b, 0 10px 20px rgba(0, 0, 0, 0.5);
            z-index: 2;
            margin-bottom: 20px;
            line-height: 1;
            transform: rotate(-3deg);
        }

        .start-btn {
            padding: 20px 60px;
            font-size: 32px;
            font-weight: bold;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 0 #b31d2a, 0 20px 30px rgba(0, 0, 0, 0.4);
            z-index: 2;
            transition: transform 0.1s;
        }

        .start-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #b31d2a;
        }
    </style>
</head>

<body>

    <div id="app-frame">
        <!-- INTRO SCREEN -->
        <div id="intro-screen">
            <img class="intro-bg" src="beaver_main.png" alt="Beaver Main">
            <div class="game-title">BEAVER<br>BASH</div>

            <div class="intro-stats">
                <div class="intro-stat-item">
                    <span class="label">HIGH SCORE</span>
                    <span class="value" id="intro-high-score">0</span>
                </div>
                <div class="intro-stat-item">
                    <span class="label">MAX COMBO</span>
                    <span class="value" id="intro-max-combo">0</span>
                </div>
            </div>

            <button class="start-btn" onclick="startGame()">JOGAR</button>
        </div>

        <!-- PAUSE OVERLAY -->
        <div id="pause-screen">
            <div class="pause-menu">
                <div class="pause-title">PAUSADO</div>
                <button class="menu-btn resume" onclick="togglePause()">CONTINUAR</button>
                <button class="menu-btn quit" onclick="window.location.reload()">SAIR</button>
            </div>
        </div>

        <!-- HEADER -->
        <div id="header-container">
            <div class="wood-btn" onclick="togglePause()">
                ❚❚
            </div>
            <div class="wood-panel">
                <div class="stat-group">
                    <span class="wood-label">Placar</span>
                    <span class="wood-value" id="score">0</span>
                </div>
                <div class="stat-group">
                    <span class="wood-label">Combo</span>
                    <span class="wood-value" id="combo-cnt-top" style="color:#ffd700">0</span>
                </div>
            </div>
            <div class="stat-group" style="padding: 0 5px;">
                <span class="wood-label">Nível</span>
                <span class="wood-value" id="level">1</span>
            </div>
            <div class="stat-group">
                <span class="wood-label">Vidas</span>
                <span class="wood-value" id="lives" style="font-size: 18px; letter-spacing: 1px;">❤❤❤</span>
            </div>
        </div>

        <!-- GRID -->
        <div id="game-container">
            <!-- 9 Cells -->
            <div class="cell" onclick="hit(0)"></div>
            <div class="cell" onclick="hit(1)"></div>
            <div class="cell" onclick="hit(2)"></div>
            <div class="cell" onclick="hit(3)"></div>
            <div class="cell" onclick="hit(4)"></div>
            <div class="cell" onclick="hit(5)"></div>
            <div class="cell" onclick="hit(6)"></div>
            <div class="cell" onclick="hit(7)"></div>
            <div class="cell" onclick="hit(8)"></div>

            <!-- COMBO OVERLAY -->
            <div id="combo-cnt" class="combo-container"></div>
        </div>

        <!-- GAME OVER -->
        <div id="game-over">
            <div class="game-over-img"></div>
            <div class="game-over-text">GAME OVER</div>

            <div class="game-over-stats">
                <div>Pontos: <span id="final-score" style="color:#fff">0</span></div>
                <div>Maior Combo: <span id="final-combo" style="color:#ffd700">0</span></div>
            </div>

            <button class="restart-btn" onclick="resetGame()">Tentar Novamente</button>
        </div>
    </div>

    <script>
        // PWA SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }

        // CONFIG
        const CONFIG = { speed: 1200, minSpeed: 650, decrease: 10 }; // Fair Play
        let state = {
            score: 0, level: 1, lives: 3,
            activeTimers: new Map(), // Tracks active beavers and their miss timers
            busyCells: new Set(), // Tracks cells currently animating/busy
            isOver: false, speed: 1000, combo: 0, maxCombo: 0, isPaused: false
        };

        // PERSISTENCE
        let records = {
            highScore: parseInt(localStorage.getItem('beaver_highScore') || 0),
            maxCombo: parseInt(localStorage.getItem('beaver_maxCombo') || 0)
        };

        // DOM
        const els = {
            cells: document.querySelectorAll('.cell'),
            intro: document.getElementById('intro-screen'),
            gameOver: document.getElementById('game-over'),
            pauseScreen: document.getElementById('pause-screen'),
            score: document.getElementById('score'),
            level: document.getElementById('level'),
            lives: document.getElementById('lives'),
            finalScore: document.getElementById('final-score'),
            finalCombo: document.getElementById('final-combo'),
            comboCnt: document.getElementById('combo-cnt'),
            introHighScore: document.getElementById('intro-high-score'),
            introMaxCombo: document.getElementById('intro-max-combo')
        };

        // INIT UI
        updateIntroStats();

        function updateIntroStats() {
            els.introHighScore.innerText = records.highScore;
            els.introMaxCombo.innerText = records.maxCombo;
        }

        function saveRecords() {
            if (state.score > records.highScore) {
                records.highScore = state.score;
                localStorage.setItem('beaver_highScore', records.highScore);
            }
            if (state.maxCombo > records.maxCombo) {
                records.maxCombo = state.maxCombo;
                localStorage.setItem('beaver_maxCombo', records.maxCombo);
            }
        }

        // AUDIO SYSTEM (Music + SFX)
        const ctx = new (window.AudioContext || window.webkitAudioContext)();

        // Simple SFX
        function beep(f, t, vol = 0.1, dur = 0.1) {
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.value = f; o.type = t;
            g.gain.setValueAtTime(vol, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
            o.start(); o.stop(ctx.currentTime + dur);
        }

        // BACKGROUND MUSIC ENGINE (NEW)
        const Music = {
            isPlaying: false,
            tempo: 1.0,
            nextNoteTime: 0,
            noteIndex: 0,
            // Funky Loop: C - E - G - A - A# - A - G - E
            melody: [523.25, 0, 659.25, 0, 783.99, 0, 880.00, 0, 932.33, 0, 880.00, 0, 783.99, 0, 659.25, 0],
            bass: [261.63, 261.63, 329.63, 329.63, 392.00, 392.00, 440.00, 440.00, 466.16, 466.16, 440.00, 440.00, 392.00, 392.00, 329.63, 329.63],
            timerID: null,

            start() {
                if (this.isPlaying) return;
                this.isPlaying = true;
                this.nextNoteTime = ctx.currentTime + 0.1;
                this.scheduler();
            },

            stop() {
                this.isPlaying = false;
                clearTimeout(this.timerID);
            },

            setTempo(multiplier) {
                this.tempo = multiplier;
            },

            scheduler() {
                if (!this.isPlaying) return;
                while (this.nextNoteTime < ctx.currentTime + 0.1) {
                    this.playStep(this.nextNoteTime);
                    const secondsPerStep = 0.125 / this.tempo; // 16th notes
                    this.nextNoteTime += secondsPerStep;
                }
                this.timerID = setTimeout(() => this.scheduler(), 25);
            },

            playStep(time) {
                const step = this.noteIndex % 16;

                // LEAD (Square - Retro Vibe)
                if (this.melody[step] > 0) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'square';
                    osc.frequency.value = this.melody[step];
                    gain.gain.setValueAtTime(0.02, time); // Low volume lead
                    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                    osc.start(time); osc.stop(time + 0.1);
                }

                // BASS (Triangle - Groovy)
                if (this.bass[step] > 0) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'triangle';
                    osc.frequency.value = this.bass[step] / 2;
                    gain.gain.setValueAtTime(0.05, time); // Louder Bass
                    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                    osc.start(time); osc.stop(time + 0.2);
                }

                this.noteIndex++;
            }
        };

        function playSadMusic() {
            Music.stop(); // Stop happy music
            const notes = [
                { f: 392.00, d: 0.5 }, { f: 311.13, d: 0.5 }, { f: 261.63, d: 0.5 },
                { f: 196.00, d: 1.0 }, { f: 155.56, d: 1.5 }
            ];
            let time = ctx.currentTime;
            notes.forEach(n => {
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'sine'; o.frequency.value = n.f;
                g.gain.setValueAtTime(0.15, time); g.gain.exponentialRampToValueAtTime(0.01, time + n.d);
                o.start(time); o.stop(time + n.d);
                time += n.d * 0.8;
            });
        }

        // PAUSE LOGIC
        function togglePause() {
            if (state.isOver) return;
            state.isPaused = !state.isPaused;

            if (state.isPaused) {
                Music.stop();
                state.activeTimers.forEach((timer, idx) => clearTimeout(timer));
                els.pauseScreen.classList.add('show');
            } else {
                els.pauseScreen.classList.remove('show');
                Music.start();
                state.activeTimers.clear();
                state.busyCells.clear();
                els.cells.forEach(c => c.innerHTML = '');
                spawn();
            }
        }

        // GAME LOOP
        function startGame() {
            if (ctx.state === 'suspended') ctx.resume();
            els.intro.classList.add('fade-out');
            resetGame();
        }

        function resetGame() {
            Music.start();
            Music.setTempo(1.0);

            if (state.activeTimers) state.activeTimers.forEach(t => clearTimeout(t));

            state = {
                score: 0, level: 1, lives: 3,
                activeTimers: new Map(),
                busyCells: new Set(),
                isOver: false, speed: 1000, combo: 0, maxCombo: 0, isPaused: false
            };

            updateUI();
            els.gameOver.classList.remove('show');
            els.cells.forEach(c => c.innerHTML = '');
            els.comboCnt.innerHTML = '';
            setTimeout(spawn, 500);
        }

        function spawn() {
            if (state.isOver || state.isPaused) return;

            // Delayed Multi-spawn: 1 beaver until lvl 10, then 2.
            const maxBeavers = Math.floor((state.level - 1) / 10) + 1;

            if (state.activeTimers.size >= maxBeavers) {
                setTimeout(spawn, 500);
                return;
            }

            let availableIdx = [];
            els.cells.forEach((_, i) => {
                if (!state.activeTimers.has(i) && !state.busyCells.has(i)) {
                    availableIdx.push(i);
                }
            });

            if (availableIdx.length === 0) {
                setTimeout(spawn, 300);
                return;
            }

            const idx = availableIdx[Math.floor(Math.random() * availableIdx.length)];

            // Create Beaver
            const beaver = document.createElement('div');
            beaver.className = 'hole-mask';
            beaver.style.pointerEvents = "none";
            beaver.innerHTML = `<div class="beaver"><div class="beaver-container"><div class="beaver-img normal"></div></div></div>`;
            els.cells[idx].appendChild(beaver);

            // Set Timer
            const timerId = setTimeout(() => miss(idx), state.speed);
            state.activeTimers.set(idx, timerId);

            const nextSpawnTime = Math.max(400, state.speed / (maxBeavers * 0.8));
            setTimeout(spawn, nextSpawnTime);
        }

        function hit(idx) {
            if (state.isOver || state.isPaused) return;

            // HANDLE EMPTY CLICK
            if (!state.activeTimers.has(idx)) {
                wrongHole();
                return;
            }

            clearTimeout(state.activeTimers.get(idx));
            state.activeTimers.delete(idx);
            state.busyCells.add(idx); // Mark busy immediately

            const cell = els.cells[idx];
            const mask = cell.querySelector('.hole-mask');
            const img = mask ? mask.querySelector('.beaver-img') : null;
            if (img) img.className = 'beaver-img yes';

            state.combo++;
            if (state.combo > state.maxCombo) state.maxCombo = state.combo;
            showComboEffect(state.combo);

            const points = 10 * state.combo;
            state.score += points;
            state.level = Math.floor(state.score / 100) + 1;

            state.speed = Math.max(CONFIG.minSpeed, CONFIG.speed - (state.level * CONFIG.decrease));
            Music.setTempo(1.0 + (state.level * 0.1));

            beep(600 + (state.combo * 50), 'square');
            updateUI();

            setTimeout(() => {
                if (els.cells[idx]) els.cells[idx].innerHTML = '';
                state.busyCells.delete(idx); // Release busy state
            }, 300);
        }

        /* NEW FUNCTION: Wrong Hole Click */
        function wrongHole() {
            state.lives--;
            state.combo = 0;
            els.comboCnt.innerHTML = '';

            beep(150, 'sawtooth'); // Error sound

            // Visual feedback (Shake container)
            const container = document.getElementById('game-container');
            container.classList.remove('shake'); // Reset anim
            void container.offsetWidth; // Trigger reflow
            container.classList.add('shake');

            updateUI();

            if (state.lives <= 0) {
                endGame();
            }
        }

        function miss(idx) {
            if (state.isOver || state.isPaused) return;

            if (!state.activeTimers.has(idx)) return;
            state.activeTimers.delete(idx);
            state.busyCells.add(idx); // Mark busy immediately

            state.combo = 0;
            els.comboCnt.innerHTML = '';

            const cell = els.cells[idx];
            const mask = cell.querySelector('.hole-mask');
            if (mask) {
                const beaver = mask.querySelector('.beaver');
                if (beaver) beaver.classList.add('miss');
                const img = mask.querySelector('.beaver-img');
                if (img) img.className = 'beaver-img no';
            }

            state.lives--;
            beep(200, 'sawtooth');
            updateUI();

            if (state.lives <= 0) {
                endGame();
            } else {
                setTimeout(() => {
                    if (els.cells[idx]) els.cells[idx].innerHTML = '';
                    state.busyCells.delete(idx); // Release busy state
                }, 300);
            }
        }

        function showComboEffect(val) {
            if (val < 2) return;
            els.comboCnt.innerHTML = `<div class="combo-pop">x${val}</div>`;
        }

        function endGame() {
            state.isOver = true;
            saveRecords();
            updateIntroStats();

            els.finalScore.innerText = state.score;
            els.finalCombo.innerText = state.maxCombo;

            els.gameOver.classList.add('show');
            playSadMusic();
        }

        function updateUI() {
            els.score.innerText = state.score;
            els.level.innerText = state.level;
            els.lives.innerHTML = '❤'.repeat(Math.max(0, state.lives));
        }
    </script>
</body>

</html>